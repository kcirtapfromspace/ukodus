<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play - Ukodus</title>
    <meta name="description" content="Play Sudoku in the browser, powered by a Rust WASM engine. Unique puzzles, human-style difficulty, keyboard-driven." />
    <meta name="theme-color" content="#f6f1e7" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Ukodus — Play Sudoku" />
    <meta property="og:description" content="Try this Sudoku puzzle! 45 solving techniques, human-style difficulty ratings, powered by Rust + WebAssembly." />
    <meta property="og:image" content="/assets/app-icon.png" />
    <meta property="og:site_name" content="Ukodus" />

    <!-- Twitter / X -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Ukodus — Play Sudoku" />
    <meta name="twitter:description" content="Try this Sudoku puzzle! 45 solving techniques, human-style difficulty ratings, powered by Rust + WebAssembly." />
    <meta name="twitter:image" content="/assets/app-icon.png" />

    <link rel="icon" type="image/png" href="../assets/app-icon.png" />
    <link rel="apple-touch-icon" href="../assets/app-icon.png" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,300..900&family=IBM+Plex+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="../assets/site.css" />
    <style>
        /* Override site.css body defaults for no-scroll play page */
        html, body {
            height: 100dvh;
            overflow: hidden;
        }

        .play-layout {
            display: grid;
            grid-template-rows: auto 1fr auto auto;
            height: 100dvh;
            min-height: 0;
        }

        /* Topbar overrides for play page */
        .topbar {
            position: relative;
        }

        /* Canvas area */
        .canvas-area {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            overflow: hidden;
            padding: 8px 12px;
        }

        .canvas-frame {
            border-radius: var(--radius);
            border: 1px solid rgba(20, 20, 20, 0.12);
            background: rgba(255, 255, 255, 0.66);
            box-shadow: var(--shadow-soft);
            padding: 6px;
            line-height: 0;
        }

        #game-canvas {
            border-radius: 16px;
            display: block;
        }

        /* Controls in nav */
        .controls-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-btn {
            font-family: var(--mono);
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(20, 20, 20, 0.12);
            background: rgba(255, 255, 255, 0.55);
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
            color: var(--ink);
        }

        .theme-btn:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.92);
            border-color: rgba(20, 20, 20, 0.16);
        }

        .theme-btn.active {
            border-color: rgba(10, 132, 255, 0.35);
            background: linear-gradient(180deg, rgba(10, 132, 255, 0.12), rgba(255, 255, 255, 0.70));
        }

        .controls-sep {
            width: 1px;
            height: 18px;
            background: rgba(20, 20, 20, 0.10);
            margin: 0 4px;
        }

        .share-btn {
            font-family: var(--mono);
            font-size: 11px;
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255, 59, 48, 0.25);
            background: linear-gradient(180deg, rgba(255, 59, 48, 0.08), rgba(255, 255, 255, 0.55));
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease;
            color: var(--ink);
        }

        .share-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(180deg, rgba(255, 59, 48, 0.14), rgba(255, 255, 255, 0.85));
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 8px 16px;
            flex-wrap: wrap;
        }

        .stat-pill {
            font-family: var(--mono);
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(20, 20, 20, 0.10);
            background: rgba(255, 255, 255, 0.50);
            color: var(--muted);
            white-space: nowrap;
        }

        .stat-pill b {
            color: var(--ink);
            font-weight: 600;
        }

        .leaderboard-btn {
            font-family: var(--mono);
            font-size: 11px;
            padding: 5px 12px;
            border-radius: 999px;
            border: 1px solid rgba(10, 132, 255, 0.25);
            background: linear-gradient(180deg, rgba(10, 132, 255, 0.08), rgba(255, 255, 255, 0.55));
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease;
            color: var(--accent2);
            font-weight: 600;
        }

        .leaderboard-btn:hover {
            transform: translateY(-1px);
            background: linear-gradient(180deg, rgba(10, 132, 255, 0.14), rgba(255, 255, 255, 0.85));
        }

        /* Footer */
        .play-footer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 8px 16px;
            font-size: 12px;
            color: var(--faint);
            flex-wrap: wrap;
        }

        .play-footer a {
            color: var(--accent2);
        }

        /* Loading state */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--serif);
            font-size: 1.2rem;
            color: var(--muted);
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Mobile warning */
        .mobile-warning {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--accent);
            font-size: 14px;
        }

        @media (max-width: 500px) {
            .mobile-warning { display: block; }
            .canvas-frame { display: none; }
        }

        /* Leaderboard overlay */
        .lb-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(20, 20, 20, 0.4);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .lb-overlay.open {
            display: flex;
        }

        .lb-panel {
            width: min(560px, calc(100vw - 32px));
            max-height: calc(100dvh - 64px);
            background: var(--paper2);
            border-radius: var(--radius);
            border: 1px solid rgba(20, 20, 20, 0.12);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .lb-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px 12px;
            border-bottom: 1px solid rgba(20, 20, 20, 0.08);
        }

        .lb-header h2 {
            font-family: var(--serif);
            font-size: 20px;
            margin: 0;
        }

        .lb-close {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(20, 20, 20, 0.10);
            background: rgba(255, 255, 255, 0.55);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            transition: background 140ms ease;
        }

        .lb-close:hover {
            background: rgba(255, 255, 255, 0.92);
        }

        .lb-tabs {
            display: flex;
            gap: 6px;
            padding: 10px 20px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .lb-tab {
            font-family: var(--mono);
            font-size: 11px;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(20, 20, 20, 0.12);
            background: rgba(255, 255, 255, 0.55);
            cursor: pointer;
            transition: background 140ms ease, border-color 140ms ease;
            white-space: nowrap;
            color: var(--ink);
        }

        .lb-tab:hover {
            background: rgba(255, 255, 255, 0.92);
        }

        .lb-tab.active {
            border-color: rgba(10, 132, 255, 0.35);
            background: linear-gradient(180deg, rgba(10, 132, 255, 0.12), rgba(255, 255, 255, 0.70));
        }

        .lb-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 16px;
        }

        .lb-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .lb-table th {
            font-family: var(--mono);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--faint);
            text-align: left;
            padding: 8px 6px;
            border-bottom: 1px solid rgba(20, 20, 20, 0.08);
            font-weight: 600;
        }

        .lb-table td {
            padding: 8px 6px;
            border-bottom: 1px solid rgba(20, 20, 20, 0.04);
            color: var(--muted);
        }

        .lb-table tr.me td {
            color: var(--accent2);
            font-weight: 600;
        }

        .lb-table .rank {
            font-family: var(--mono);
            font-weight: 700;
            color: var(--ink);
            width: 36px;
        }

        .lb-table .player {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: var(--mono);
            font-size: 12px;
        }

        .lb-table .time {
            font-family: var(--mono);
            font-weight: 600;
        }

        .lb-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--faint);
            font-size: 14px;
        }

        /* Tag prompt modal */
        .tag-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 200;
            background: rgba(10, 10, 15, 0.65);
            backdrop-filter: blur(12px);
            align-items: center;
            justify-content: center;
        }

        .tag-overlay.open {
            display: flex;
        }

        .tag-panel {
            width: min(380px, calc(100vw - 32px));
            padding: 36px 32px 28px;
            background: #1a1a2e;
            border-radius: 16px;
            border: 1.5px solid rgba(120, 100, 255, 0.3);
            box-shadow: 0 0 40px rgba(120, 100, 255, 0.15), 0 8px 32px rgba(0,0,0,0.4);
            text-align: center;
        }

        .tag-panel h2 {
            font-family: var(--mono);
            font-size: 20px;
            letter-spacing: 4px;
            color: #e0d8ff;
            margin: 0 0 24px;
            text-transform: uppercase;
        }

        .tag-panel input {
            display: block;
            width: 100%;
            box-sizing: border-box;
            font-family: var(--mono);
            font-size: 28px;
            letter-spacing: 6px;
            text-align: center;
            text-transform: uppercase;
            padding: 12px 16px;
            background: rgba(255,255,255,0.06);
            border: 1.5px solid rgba(120, 100, 255, 0.35);
            border-radius: 10px;
            color: #fff;
            outline: none;
            transition: border-color 200ms ease;
        }

        .tag-panel input::placeholder {
            color: rgba(255,255,255,0.2);
            letter-spacing: 6px;
        }

        .tag-panel input:focus {
            border-color: rgba(120, 100, 255, 0.7);
        }

        .tag-hint {
            font-family: var(--mono);
            font-size: 11px;
            color: rgba(255,255,255,0.35);
            margin: 10px 0 20px;
        }

        .tag-error {
            font-family: var(--mono);
            font-size: 11px;
            color: #ff6b6b;
            margin: -6px 0 14px;
            min-height: 16px;
        }

        .tag-panel button {
            font-family: var(--mono);
            font-size: 14px;
            letter-spacing: 3px;
            text-transform: uppercase;
            padding: 12px 40px;
            border-radius: 999px;
            border: 1.5px solid rgba(120, 100, 255, 0.4);
            background: linear-gradient(180deg, rgba(120, 100, 255, 0.2), rgba(120, 100, 255, 0.05));
            color: #e0d8ff;
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
        }

        .tag-panel button:hover:not(:disabled) {
            transform: translateY(-1px);
            background: linear-gradient(180deg, rgba(120, 100, 255, 0.35), rgba(120, 100, 255, 0.1));
            border-color: rgba(120, 100, 255, 0.6);
        }

        .tag-panel button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        /* Tag pill in stats bar */
        .tag-pill {
            cursor: pointer;
            transition: transform 140ms ease, background 140ms ease;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .tag-pill:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.75);
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">Loading Sudoku</div>

    <div class="play-layout" id="game-container" style="display: none;">
        <!-- Row 1: Topbar -->
        <header class="topbar" id="topbar">
            <div class="wrap topbar-inner">
                <a class="brand" href="../" aria-label="Ukodus home">
                    <img src="../assets/app-icon.png" alt="" width="34" height="34" />
                    <div class="wordmark">
                        <strong>Ukodus</strong>
                        <span>Play Sudoku</span>
                    </div>
                </a>
                <nav aria-label="Primary">
                    <a class="navlink" href="../">Home</a>
                    <a class="navlink" href="../galaxy/">Galaxy</a>
                    <div class="controls-row">
                        <button class="theme-btn active" data-theme="ukodus">Ukodus</button>
                        <button class="theme-btn" data-theme="dark">Dark</button>
                        <button class="theme-btn" data-theme="light">Light</button>
                        <button class="theme-btn" data-theme="high_contrast">Hi-Con</button>
                        <span class="controls-sep"></span>
                        <button class="share-btn" id="share-btn">Share</button>
                    </div>
                </nav>
            </div>
        </header>

        <!-- Row 2: Canvas area -->
        <div class="canvas-area">
            <div class="canvas-frame">
                <canvas id="game-canvas" width="1000" height="700"></canvas>
            </div>
            <div class="mobile-warning">
                This game requires a keyboard.<br>
                Please use a desktop browser.
            </div>
        </div>

        <!-- Row 3: Stats bar -->
        <div class="stats-bar" id="stats-bar">
            <span class="stat-pill tag-pill" id="tag-display" title="Click to change tag"></span>
            <span class="stat-pill">Played <b id="stat-played">0</b></span>
            <span class="stat-pill">Win% <b id="stat-winpct">0</b></span>
            <span class="stat-pill">Streak <b id="stat-streak">0</b></span>
            <span class="stat-pill">Best <b id="stat-best">--:--</b></span>
            <button class="leaderboard-btn" id="lb-open">Leaderboard</button>
        </div>

        <!-- Row 4: Footer -->
        <footer class="play-footer" id="play-footer">
            <span>Rust + WebAssembly</span>
            <span>&middot;</span>
            <a href="../galaxy/">Explore Galaxy</a>
            <span>&middot;</span>
            <a href="https://github.com/kcirtapfromspace/sudoku" target="_blank">Source</a>
        </footer>
    </div>

    <!-- Tag prompt overlay -->
    <div class="tag-overlay" id="tag-overlay">
        <div class="tag-panel">
            <h2>Enter Your Tag</h2>
            <input type="text" id="tag-input" maxlength="6" placeholder="ACE"
                   autocomplete="off" spellcheck="false">
            <p class="tag-hint">3-6 characters &middot; A-Z 0-9</p>
            <p class="tag-error" id="tag-error"></p>
            <button id="tag-submit" disabled>START</button>
        </div>
    </div>

    <!-- Leaderboard overlay -->
    <div class="lb-overlay" id="lb-overlay">
        <div class="lb-panel">
            <div class="lb-header">
                <h2>Leaderboard</h2>
                <button class="lb-close" id="lb-close" aria-label="Close">&times;</button>
            </div>
            <div class="lb-tabs" id="lb-tabs">
                <button class="lb-tab active" data-diff="Beginner">Beginner</button>
                <button class="lb-tab" data-diff="Easy">Easy</button>
                <button class="lb-tab" data-diff="Medium">Medium</button>
                <button class="lb-tab" data-diff="Intermediate">Intermediate</button>
                <button class="lb-tab" data-diff="Hard">Hard</button>
                <button class="lb-tab" data-diff="Expert">Expert</button>
            </div>
            <div class="lb-body" id="lb-body">
                <div class="lb-empty">Select a difficulty to view the leaderboard.</div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { SudokuGame } from '../wasm/sudoku_wasm.js?v=6';
        import { GameBridge } from '../assets/game-bridge.js?v=6';

        let game = null;
        let bridge = null;
        let animationId = null;
        let leaderboardOpen = false;

        const TAG_KEY = 'ukodus_player_tag';
        const TAG_RE = /^[A-Z0-9]{3,6}$/;

        function showTagPrompt(prefill) {
            return new Promise(resolve => {
                const overlay = document.getElementById('tag-overlay');
                const input = document.getElementById('tag-input');
                const btn = document.getElementById('tag-submit');
                const error = document.getElementById('tag-error');

                input.value = prefill || '';
                error.textContent = '';
                btn.disabled = !TAG_RE.test(input.value);
                overlay.classList.add('open');
                input.focus();

                function validate() {
                    const val = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    input.value = val;
                    const valid = TAG_RE.test(val);
                    btn.disabled = !valid;
                    if (val.length > 0 && val.length < 3) {
                        error.textContent = 'Too short — need at least 3';
                    } else if (!valid && val.length >= 3) {
                        error.textContent = 'A-Z and 0-9 only';
                    } else {
                        error.textContent = '';
                    }
                }

                function submit() {
                    const val = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    if (!TAG_RE.test(val)) return;
                    localStorage.setItem(TAG_KEY, val);
                    overlay.classList.remove('open');
                    updateTagDisplay();
                    cleanup();
                    resolve(val);
                }

                function onInput() { validate(); }
                function onKeydown(e) { if (e.key === 'Enter') submit(); }
                function onClick() { submit(); }

                function cleanup() {
                    input.removeEventListener('input', onInput);
                    input.removeEventListener('keydown', onKeydown);
                    btn.removeEventListener('click', onClick);
                }

                input.addEventListener('input', onInput);
                input.addEventListener('keydown', onKeydown);
                btn.addEventListener('click', onClick);
            });
        }

        function updateTagDisplay() {
            const el = document.getElementById('tag-display');
            const tag = localStorage.getItem(TAG_KEY);
            if (tag) {
                el.textContent = tag;
                el.style.display = '';
            } else {
                el.style.display = 'none';
            }
        }

        // --- Stats helpers ---
        function updateStats() {
            if (!game) return;
            try {
                const raw = game.get_stats_json();
                if (!raw) return;
                const stats = JSON.parse(raw);
                document.getElementById('stat-played').textContent = stats.games_played || 0;
                const winPct = stats.games_played > 0
                    ? Math.round((stats.games_won / stats.games_played) * 100)
                    : 0;
                document.getElementById('stat-winpct').textContent = winPct + '%';
                document.getElementById('stat-streak').textContent = stats.current_streak || 0;
                if (stats.best_time && stats.best_time < 999999) {
                    const m = Math.floor(stats.best_time / 60);
                    const s = stats.best_time % 60;
                    document.getElementById('stat-best').textContent =
                        m + ':' + String(s).padStart(2, '0');
                } else {
                    document.getElementById('stat-best').textContent = '--:--';
                }
            } catch { /* stats not available yet */ }
        }

        // --- Leaderboard helpers (DOM-based, no innerHTML) ---
        function formatTime(secs) {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return m + ':' + String(s).padStart(2, '0');
        }

        function truncateId(id) {
            if (!id) return '???';
            return id.substring(0, 8);
        }

        function clearLbBody() {
            const body = document.getElementById('lb-body');
            while (body.firstChild) body.removeChild(body.firstChild);
            return body;
        }

        function showLbMessage(text) {
            const body = clearLbBody();
            const div = document.createElement('div');
            div.className = 'lb-empty';
            div.textContent = text;
            body.appendChild(div);
        }

        function buildLbTable(data) {
            const body = clearLbBody();
            const playerId = localStorage.getItem('ukodus_player_id') || '';

            const table = document.createElement('table');
            table.className = 'lb-table';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Rank', 'Player', 'Time', 'Hints', 'Errors'].forEach(label => {
                const th = document.createElement('th');
                th.textContent = label;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            data.forEach((entry, i) => {
                const tr = document.createElement('tr');
                if (entry.player_id === playerId) tr.className = 'me';

                const tdRank = document.createElement('td');
                tdRank.className = 'rank';
                tdRank.textContent = i + 1;
                tr.appendChild(tdRank);

                const tdPlayer = document.createElement('td');
                tdPlayer.className = 'player';
                tdPlayer.textContent = entry.player_tag || truncateId(entry.player_id);
                tdPlayer.title = entry.player_tag || entry.player_id;
                tr.appendChild(tdPlayer);

                const tdTime = document.createElement('td');
                tdTime.className = 'time';
                tdTime.textContent = formatTime(entry.time_secs);
                tr.appendChild(tdTime);

                const tdHints = document.createElement('td');
                tdHints.textContent = entry.hints_used;
                tr.appendChild(tdHints);

                const tdErrors = document.createElement('td');
                tdErrors.textContent = entry.mistakes;
                tr.appendChild(tdErrors);

                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            body.appendChild(table);
        }

        async function fetchLeaderboard(difficulty) {
            showLbMessage('Loading...');
            try {
                const resp = await fetch(
                    '/api/v1/results/leaderboard?difficulty=' + encodeURIComponent(difficulty) + '&limit=20'
                );
                if (!resp.ok) throw new Error('API error');
                const data = await resp.json();
                if (!data || data.length === 0) {
                    showLbMessage('No results yet for this difficulty.');
                    return;
                }
                buildLbTable(data);
            } catch {
                showLbMessage('Could not load leaderboard.');
            }
        }

        function openLeaderboard() {
            leaderboardOpen = true;
            document.getElementById('lb-overlay').classList.add('open');
            const activeTab = document.querySelector('.lb-tab.active');
            if (activeTab) fetchLeaderboard(activeTab.dataset.diff);
        }

        function closeLeaderboard() {
            leaderboardOpen = false;
            document.getElementById('lb-overlay').classList.remove('open');
        }

        // --- Theme background mapping ---
        function setPageBackground(theme) {
            const layout = document.getElementById('game-container');
            if (theme === 'dark') {
                document.body.style.background = '#18182a';
                layout.style.background = '#18182a';
            } else if (theme === 'high_contrast') {
                document.body.style.background = '#000';
                layout.style.background = '#000';
            } else if (theme === 'light') {
                document.body.style.background = '#f5f5fa';
                layout.style.background = '#f5f5fa';
            } else {
                // ukodus (default)
                document.body.style.background = '';
                layout.style.background = '';
            }
        }

        // --- Main ---
        async function main() {
            try {
                await init({ module_or_path: new URL('../wasm/sudoku_wasm_bg.wasm?v=6', import.meta.url) });
                game = new SudokuGame('game-canvas');

                // Calculate size to fit in viewport without scroll
                function calculateGameSize() {
                    const topbar = document.getElementById('topbar');
                    const statsBar = document.getElementById('stats-bar');
                    const footer = document.getElementById('play-footer');

                    const chromeH = (topbar ? topbar.offsetHeight : 50)
                        + (statsBar ? statsBar.offsetHeight : 36)
                        + (footer ? footer.offsetHeight : 32)
                        + 32; // padding
                    const availH = window.innerHeight - chromeH;
                    const availW = Math.min(window.innerWidth - 40, 1400);

                    return {
                        width: Math.max(400, availW),
                        height: Math.max(300, availH)
                    };
                }

                const initial = calculateGameSize();
                game.resize(initial.width, initial.height);

                // Default to ukodus theme
                game.set_theme('ukodus');

                // Show game
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game-container').style.display = 'grid';

                // Re-measure after layout paints
                requestAnimationFrame(() => {
                    const size = calculateGameSize();
                    game.resize(size.width, size.height);
                });

                // Resize handling
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        const size = calculateGameSize();
                        game.resize(size.width, size.height);
                    }, 100);
                });

                // "Back to Galaxy" link if ?from=galaxy
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('from') === 'galaxy') {
                    const nav = document.querySelector('nav[aria-label="Primary"]');
                    const backLink = document.createElement('a');
                    backLink.href = '../galaxy/';
                    backLink.className = 'navlink';
                    backLink.textContent = 'Back to Galaxy';
                    backLink.style.borderColor = 'rgba(10, 132, 255, 0.35)';
                    backLink.style.color = 'var(--accent2)';
                    nav.prepend(backLink);
                }

                // Keyboard handling
                document.addEventListener('keydown', (event) => {
                    // Block game keys while tag overlay is open
                    if (document.getElementById('tag-overlay').classList.contains('open')) {
                        return;
                    }

                    // Block game keys while leaderboard is open
                    if (leaderboardOpen) {
                        if (event.key === 'Escape') {
                            closeLeaderboard();
                            event.preventDefault();
                        }
                        return;
                    }

                    const gameKeys = [
                        'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight',
                        'h', 'j', 'k', 'l', 'w', 'a', 's', 'd',
                        '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
                        'c', 'u', 'p', 'n', 'q', 'f', 'x',
                        'Delete', 'Backspace', ' ', 'Enter', 'Escape',
                        '?', '!'
                    ];

                    if (gameKeys.includes(event.key) ||
                        (event.ctrlKey && event.key === 'r')) {
                        event.preventDefault();
                    }

                    game.handle_key(event);
                });

                // Theme buttons
                document.querySelectorAll('.theme-btn[data-theme]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const theme = btn.dataset.theme;
                        game.set_theme(theme);

                        document.querySelectorAll('.theme-btn[data-theme]').forEach(b =>
                            b.classList.remove('active')
                        );
                        btn.classList.add('active');
                        setPageBackground(theme);
                    });
                });

                // Game loop
                function gameLoop() {
                    game.tick();
                    animationId = requestAnimationFrame(gameLoop);
                }
                gameLoop();

                // Save/load
                window.addEventListener('beforeunload', () => {
                    localStorage.setItem('sudoku_save', game.get_state_json());
                });

                // URL parameters: ?s= (short code) or ?p= (puzzle string)
                const shortCode = urlParams.get('s');
                const sharedPuzzle = urlParams.get('p');

                if (shortCode && shortCode.length === 8) {
                    try {
                        game.load_short_code(shortCode);
                    } catch { /* invalid code */ }
                } else if (sharedPuzzle && sharedPuzzle.length === 81) {
                    try {
                        game.load_puzzle_string(sharedPuzzle);
                    } catch { /* invalid puzzle */ }
                } else {
                    const saved = localStorage.getItem('sudoku_save');
                    if (saved) {
                        try { game.load_state_json(saved); } catch { /* corrupt save */ }
                    }
                }

                // Share button
                document.getElementById('share-btn').addEventListener('click', async () => {
                    const btn = document.getElementById('share-btn');
                    const sc = game.get_short_code();
                    const ps = game.get_puzzle_string();
                    const code = sc || ps;
                    if (!code) return;

                    const baseUrl = window.location.origin;
                    const paramKey = sc ? 's' : 'p';
                    const shareUrl = baseUrl + '/play/?' + paramKey + '=' + code;
                    const difficulty = game.difficulty();

                    // Register share (fire-and-forget)
                    if (sc) {
                        fetch('/api/v1/share', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                short_code: sc,
                                puzzle_string: ps,
                                difficulty: difficulty,
                                se_rating: game.se_rating(),
                                platform: 'web',
                                player_id: localStorage.getItem('ukodus_player_id') || 'anon'
                            })
                        }).catch(() => {});
                    }

                    const shareData = {
                        title: 'Sudoku Puzzle \u2014 ' + difficulty,
                        text: 'Try this ' + difficulty + ' Sudoku puzzle on Ukodus!',
                        url: shareUrl
                    };

                    const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);
                    if (isMobile && navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                            btn.textContent = 'Shared!';
                            setTimeout(() => { btn.textContent = 'Share'; }, 2000);
                            return;
                        } catch (e) {
                            if (e.name === 'AbortError') return;
                        }
                    }

                    try {
                        await navigator.clipboard.writeText(shareUrl);
                    } catch {
                        const ta = document.createElement('textarea');
                        ta.value = shareUrl;
                        ta.style.position = 'fixed';
                        ta.style.opacity = '0';
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                    }
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Share'; }, 2000);
                });

                // Stats: update on load and poll every 5s
                updateStats();
                setInterval(updateStats, 5000);

                // Leaderboard
                document.getElementById('lb-open').addEventListener('click', openLeaderboard);
                document.getElementById('lb-close').addEventListener('click', closeLeaderboard);
                document.getElementById('lb-overlay').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) closeLeaderboard();
                });
                document.querySelectorAll('.lb-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        fetchLeaderboard(tab.dataset.diff);
                    });
                });

                // Tag display + edit
                updateTagDisplay();
                document.getElementById('tag-display').addEventListener('click', () => {
                    showTagPrompt(localStorage.getItem(TAG_KEY) || '');
                });

                // Prompt for tag on first visit
                if (!localStorage.getItem(TAG_KEY)) {
                    await showTagPrompt();
                }

                // Start game bridge
                bridge = new GameBridge(game);
                bridge.start();

            } catch (error) {
                document.getElementById('loading').textContent =
                    'Failed to load: ' + error.message + ' (Check browser console F12 for details)';
            }
        }

        main();
    </script>
</body>
</html>
